# ==============================================================================
# ARK Log Rotation Configuration (REQ_LOG_01)
# ==============================================================================
#
# This configuration manages log rotation for all ARK components to prevent
# disk space exhaustion and maintain manageable log files.
#
# Installation:
#   1. System-wide: sudo cp config/logrotate.conf /etc/logrotate.d/ark
#   2. Manual rotation: logrotate -f config/logrotate.conf
#   3. Test: logrotate -d config/logrotate.conf
#
# ==============================================================================

# Default settings for all ARK logs
# ==============================================================================

# Backend API logs
/home/user/webapp/logs/backend.log {
    daily                    # Rotate daily
    rotate 7                 # Keep 7 days of logs
    maxsize 50M              # Rotate if file exceeds 50MB
    compress                 # Compress old logs
    delaycompress            # Don't compress most recent rotation
    missingok                # Don't error if log file is missing
    notifempty               # Don't rotate if log is empty
    create 0640 user user    # Create new log with these permissions
    sharedscripts            # Run postrotate script only once
    
    postrotate
        # Send SIGHUP to backend process to reopen log file
        pkill -HUP -f reasoning_api.py 2>/dev/null || true
    endscript
}

# Frontend logs
/home/user/webapp/logs/frontend.log {
    daily
    rotate 7
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
    sharedscripts
    
    postrotate
        # Vite will automatically reopen log on next write
        true
    endscript
}

# Agent logs (consolidated)
/home/user/webapp/logs/agents.log {
    daily
    rotate 14                # Keep 2 weeks for agent logs
    maxsize 100M             # Agents can be more verbose
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Reasoning logs
/home/user/webapp/logs/reasoning.log {
    daily
    rotate 14                # Keep 2 weeks
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Reflection system logs
/home/user/webapp/logs/reflection.log {
    daily
    rotate 30                # Keep 1 month
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Memory engine logs
/home/user/webapp/logs/memory.log {
    daily
    rotate 30
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Federation logs
/home/user/webapp/logs/federation.log {
    daily
    rotate 14
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Individual agent logs
/home/user/webapp/logs/kyle.log
/home/user/webapp/logs/joey.log
/home/user/webapp/logs/kenny.log
/home/user/webapp/logs/hrm.log
/home/user/webapp/logs/aletheia.log
/home/user/webapp/logs/id.log {
    daily
    rotate 14
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# Error logs (keep longer)
/home/user/webapp/logs/error.log {
    daily
    rotate 30                # Keep 1 month of error logs
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
    
    # Alert on rotation if errors present
    postrotate
        if [ -s /home/user/webapp/logs/error.log.1 ]; then
            echo "⚠️  Error log rotated - check /home/user/webapp/logs/error.log.1"
        fi
    endscript
}

# Audit logs (keep longest, never delete)
/home/user/webapp/logs/audit.log {
    weekly                   # Rotate weekly
    rotate 52                # Keep 1 year
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 user user    # Restrictive permissions for audit logs
    
    # Audit logs should never be deleted automatically
    # Manual cleanup required after archival
}

# Admin audit logs
/home/user/webapp/logs/admin_audit.log {
    weekly
    rotate 52                # Keep 1 year
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 user user    # Restrictive permissions
}

# Governance logs
/home/user/webapp/logs/governance.log {
    weekly
    rotate 52                # Keep 1 year
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 user user
}

# Wildcard for any other logs in logs/ directory
/home/user/webapp/logs/*.log {
    daily
    rotate 7
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 user user
}

# ==============================================================================
# Notes:
# ==============================================================================
#
# Rotation Schedule:
# - Application logs: Daily, keep 7 days
# - Agent/Reasoning logs: Daily, keep 14 days
# - Memory/Reflection logs: Daily, keep 30 days
# - Audit logs: Weekly, keep 52 weeks (1 year)
#
# Size Limits:
# - Standard logs: 50MB max
# - Verbose logs (agents, reasoning): 100MB max
#
# Compression:
# - All rotated logs are gzip compressed
# - Most recent rotation is NOT compressed (delaycompress)
#
# Permissions:
# - Standard logs: 0640 (owner: rw, group: r, other: none)
# - Audit logs: 0600 (owner: rw only)
#
# Manual Rotation:
#   logrotate -f /home/user/webapp/config/logrotate.conf
#
# Dry Run (test without rotating):
#   logrotate -d /home/user/webapp/config/logrotate.conf
#
# System-wide Installation:
#   sudo cp /home/user/webapp/config/logrotate.conf /etc/logrotate.d/ark
#   sudo chown root:root /etc/logrotate.d/ark
#   sudo chmod 644 /etc/logrotate.d/ark
#
# Cron Integration:
#   Logrotate typically runs daily via /etc/cron.daily/logrotate
#   No manual cron entry needed for system-wide installation
#
# ==============================================================================
