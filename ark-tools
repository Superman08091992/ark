#!/bin/bash
#
# ARK Tools Launcher
# Unified interface for all ARK management tools
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

ARK_BASE_PATH="${ARK_BASE_PATH:-$(cd "$(dirname "$0")" && pwd)}"
TOOLS_DIR="$ARK_BASE_PATH/tools"

print_header() {
    echo -e "\n${CYAN}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  ${MAGENTA}$1${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════════╝${NC}\n"
}

print_tool() {
    echo -e "${GREEN}  $1${NC} - ${BLUE}$2${NC}"
}

show_main_menu() {
    print_header "ARK TOOLS SUITE - Management & Monitoring"
    
    echo -e "${YELLOW}System Management:${NC}"
    print_tool "admin" "System administration, health checks, database management"
    print_tool "monitor" "Real-time system monitoring dashboard"
    print_tool "backup" "Backup and restore operations"
    
    echo -e "\n${YELLOW}Data & Federation:${NC}"
    print_tool "db" "Database queries, exports, and analysis"
    print_tool "federation" "P2P network and peer management"
    
    echo -e "\n${YELLOW}Development:${NC}"
    print_tool "dev" "Development workflow tools"
    
    echo -e "\n${YELLOW}Quick Actions:${NC}"
    print_tool "health" "Quick system health check"
    print_tool "status" "Show current system status"
    
    echo -e "\n${CYAN}Usage:${NC}"
    echo -e "  ${GREEN}$0 <tool> [args]${NC}"
    echo -e "  ${GREEN}$0 admin health${NC}          - Run health check"
    echo -e "  ${GREEN}$0 monitor${NC}                - Start real-time monitoring"
    echo -e "  ${GREEN}$0 backup full${NC}            - Create full backup"
    echo -e "  ${GREEN}$0 db list ark${NC}            - List ARK database tables"
    echo -e "  ${GREEN}$0 federation peers${NC}       - List federation peers"
    echo -e "  ${GREEN}$0 dev start${NC}              - Start development servers"
    
    echo -e "\n${CYAN}Help:${NC}"
    echo -e "  ${GREEN}$0 help${NC}                  - Show this menu"
    echo -e "  ${GREEN}$0 <tool> --help${NC}         - Show tool-specific help"
    
    echo ""
}

# Quick actions
quick_health() {
    print_header "QUICK HEALTH CHECK"
    python3 "$TOOLS_DIR/admin/ark-admin.py" health
}

quick_status() {
    print_header "SYSTEM STATUS"
    
    # Check services
    echo -e "${YELLOW}Services:${NC}"
    if pgrep -f "reasoning_api" > /dev/null; then
        echo -e "  ${GREEN}✅ Backend (reasoning_api)${NC}"
    else
        echo -e "  ${RED}❌ Backend (not running)${NC}"
    fi
    
    if pgrep -f "redis-server" > /dev/null; then
        echo -e "  ${GREEN}✅ Redis${NC}"
    else
        echo -e "  ${YELLOW}⚠️  Redis (not running)${NC}"
    fi
    
    # Check databases
    echo -e "\n${YELLOW}Databases:${NC}"
    if [ -f "$ARK_BASE_PATH/data/ark.db" ]; then
        size=$(du -h "$ARK_BASE_PATH/data/ark.db" | cut -f1)
        echo -e "  ${GREEN}✅ ark.db ($size)${NC}"
    else
        echo -e "  ${RED}❌ ark.db (not found)${NC}"
    fi
    
    if [ -f "$ARK_BASE_PATH/data/reasoning_logs.db" ]; then
        size=$(du -h "$ARK_BASE_PATH/data/reasoning_logs.db" | cut -f1)
        echo -e "  ${GREEN}✅ reasoning_logs.db ($size)${NC}"
    else
        echo -e "  ${RED}❌ reasoning_logs.db (not found)${NC}"
    fi
    
    # Disk space
    echo -e "\n${YELLOW}Disk Space:${NC}"
    df -h "$ARK_BASE_PATH" | tail -1 | awk '{print "  Used: "$3" / "$2" ("$5")"}'
    
    echo ""
}

# Tool router
route_tool() {
    local tool="$1"
    shift
    
    case "$tool" in
        admin)
            python3 "$TOOLS_DIR/admin/ark-admin.py" "$@"
            ;;
        
        monitor)
            python3 "$TOOLS_DIR/monitoring/ark-monitor.py" "$@"
            ;;
        
        backup)
            "$TOOLS_DIR/backup/ark-backup.sh" "$@"
            ;;
        
        db|database)
            python3 "$TOOLS_DIR/database/ark-db.py" "$@"
            ;;
        
        federation|fed)
            python3 "$TOOLS_DIR/federation/ark-federation.py" "$@"
            ;;
        
        dev)
            "$TOOLS_DIR/dev/ark-dev.sh" "$@"
            ;;
        
        health)
            quick_health
            ;;
        
        status)
            quick_status
            ;;
        
        help|--help|-h|"")
            show_main_menu
            ;;
        
        *)
            echo -e "${RED}❌ Unknown tool: $tool${NC}"
            echo -e "Run ${GREEN}$0 help${NC} to see available tools"
            exit 1
            ;;
    esac
}

# Main execution
if [ $# -eq 0 ]; then
    show_main_menu
else
    route_tool "$@"
fi
